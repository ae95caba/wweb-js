const axios = require("axios");

// Estado de conversaciÃ³n por usuario
const userStates = {}; // { [userId]: { state: 'menu' | 'option1' | 'option2' | etc } }

// FunciÃ³n para mostrar el menÃº principal
function getMainMenu() {
  return `ðŸ¤– *Bienvenido al Bot*

Por favor, selecciona una opciÃ³n:

1ï¸âƒ£ *InformaciÃ³n*
2ï¸âƒ£ *Servicios*
3ï¸âƒ£ *Contacto*
4ï¸âƒ£ *Ayuda*
5ï¸âƒ£ *Salir*

Responde con el nÃºmero de la opciÃ³n (1-5)`;
}

// FunciÃ³n para manejar las opciones del menÃº
function handleMenuOption(option, userId) {
  switch (option) {
    case "1":
      return `â„¹ï¸ *InformaciÃ³n*
      
Somos una empresa dedicada a brindar soluciones tecnolÃ³gicas de calidad. Nuestro equipo estÃ¡ comprometido con la excelencia y la innovaciÃ³n.

Â¿Deseas volver al menÃº principal? Responde con "menu"`;

    case "2":
      return `ðŸ› ï¸ *Servicios*
      
Ofrecemos los siguientes servicios:
â€¢ Desarrollo web
â€¢ Aplicaciones mÃ³viles
â€¢ ConsultorÃ­a IT
â€¢ Soporte tÃ©cnico

Â¿Deseas volver al menÃº principal? Responde con "menu"`;

    case "3":
      return `ðŸ“ž *Contacto*
      
Puedes contactarnos a travÃ©s de:
â€¢ WhatsApp: +1234567890
â€¢ Email: info@empresa.com
â€¢ Web: www.empresa.com

Â¿Deseas volver al menÃº principal? Responde con "menu"`;

    case "4":
      return `â“ *Ayuda*
      
Si necesitas ayuda, puedes:
â€¢ Escribir "menu" para volver al menÃº principal
â€¢ Contactar a soporte: +1234567890
â€¢ Visitar nuestra web: www.empresa.com/ayuda

Â¿Deseas volver al menÃº principal? Responde con "menu"`;

    case "5":
      userStates[userId] = { state: "menu" };
      return `ðŸ‘‹ *Â¡Hasta luego!*
      
Gracias por usar nuestro bot. Â¡Que tengas un excelente dÃ­a!

Para volver a empezar, escribe "hola" o "menu"`;

    default:
      return `âŒ OpciÃ³n no vÃ¡lida. Por favor, selecciona un nÃºmero del 1 al 5.

${getMainMenu()}`;
  }
}

// FunciÃ³n principal para manejar mensajes del bot
function handleBotMessage(message) {
  const userId = message.from;
  const userMessage = message.body ? message.body.toLowerCase().trim() : "";

  // Inicializar estado del usuario si no existe
  if (!userStates[userId]) {
    userStates[userId] = { state: "menu" };
  }

  let response = "";

  // Manejar comandos especiales
  if (
    userMessage === "hola" ||
    userMessage === "menu" ||
    userMessage === "inicio"
  ) {
    userStates[userId] = { state: "menu" };
    response = getMainMenu();
  }
  // Manejar opciones del menÃº
  else if (userStates[userId].state === "menu") {
    if (["1", "2", "3", "4", "5"].includes(userMessage)) {
      response = handleMenuOption(userMessage, userId);
    } else {
      response = `âŒ Por favor, selecciona una opciÃ³n vÃ¡lida (1-5).

${getMainMenu()}`;
    }
  }
  // Si no hay respuesta vÃ¡lida
  else {
    response = `âŒ Comando no reconocido. Escribe "menu" para volver al menÃº principal.

${getMainMenu()}`;
  }

  return response;
}

async function shouldIgnoreMessage(message) {
  let name;
  let log;
  const isFromMe = message._data.id.fromMe;
  const targetNumber = "5491130350056@c.us"; // The number you don't want to forward messages to/from

  const hasImage = message.type === "image";

  const chat = await message.getChat();
  // Check if the chat is archived
  const isArchived = chat.archived;
  // Ignore status updates (WhatsApp Stories)
  const isStory = message.from === "status@broadcast";
  const isSticker = message.type === "sticker";
  const isVoiceMessage = message.type === "ptt";
  console.log("message type is: ");
  console.log(message.type);
  const isTextLess = !message.body || message.body === "";

  //ignore group messages
  const isGroupChat = chat.id.server === "g.us";
  //ignore muted chats
  const isMuted = chat.muteExpiration === -1;
  // Skip empty or "This message can't be displayed here" messages
  const isEmpty = !hasImage && isTextLess && !isVoiceMessage && !isSticker;
  // Ignore messages sent to or received from the target number
  const isIrrelevant =
    message.from === targetNumber || message.to === targetNumber;
  const reasonsToIgnoreMessage = [];

  if (isGroupChat) reasonsToIgnoreMessage.push("isGroupChat");
  if (isArchived) reasonsToIgnoreMessage.push("isArchived");
  if (isStory) reasonsToIgnoreMessage.push("isStory");

  /* if (isIrrelevant) reasonsToIgnoreMessage.push("isIrrelevant"); */
  if (isMuted) reasonsToIgnoreMessage.push("isMuted");
  if (isEmpty) reasonsToIgnoreMessage.push("isEmpty");

  if (reasonsToIgnoreMessage.length > 0) {
    console.log("--------------- START -------------------");
    console.log("return triggered");
    console.log("reason:", reasonsToIgnoreMessage.join(", "));
    console.log("--------------- END -------------------");
    return reasonsToIgnoreMessage.length;
  }
}

module.exports = { shouldIgnoreMessage, handleBotMessage };
